name: Deploy Next.js to Production Server

on:
  push:
    branches:
      - main

env:
  DEPLOY_PATH: /home/rojgariindia.com/app
  
jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ‚¨áÔ∏è Checkout code
      uses: actions/checkout@v4

    - name: üöÄ Deploy to Server and Run Setup via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |

          echo "--- Starting full deployment script on server ---"
          
          # 1. Navigate to the application directory
          cd ${{ env.DEPLOY_PATH }}
          
          # 2. Pull the latest code from GitHub
          if [ ! -d .git ]; then
            echo "Initializing Git repository and cloning..."
            git init
            git remote add origin https://github.com/PrinceKhimani78/rojgariindia.com.git
          fi
          
          echo "Pulling latest code..."
          git fetch
          git reset --hard origin/main
          
          # 3. Install dependencies
          echo "Installing dependencies..."
          npm install

          # 4. Build the Next.js application
          echo "Building application..."
          npm run build

          # 5. Check if PM2 process exists, then RELOAD or START
          # This logic ensures 0-downtime and forces the new build to be loaded.
          if pm2 list | grep -q "rojgari-next"; then
            echo "Reloading existing PM2 process to load new build..."
            pm2 reload rojgari-next --update-env
          else
            echo "Starting new PM2 process for the first time..."
            pm2 start ./start.sh --name rojgari-next --interpreter 'bash' --update-env
          fi
          
          # Save PM2 configuration to ensure the process restarts after server reboot
          pm2 save
          
          # 6. Restart Nginx to clear any potential proxy cache
          echo "Restarting Nginx to clear cache..."
          sudo systemctl restart nginx
          
          echo "--- Deployment finished successfully! ---"